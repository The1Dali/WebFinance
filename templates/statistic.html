{% extends "layout.html" %}

{% block title %}
    Statistics
{% endblock %}

{% block head %}
<script src="static/statistics.js"></script>
{% endblock %}

{% block main %}
    <div class="container py-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="/" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back
            </a>
            <a href="/add" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Add Transaction
            </a>
        </div>
        <div class="d-flex justify-content-center align-items-center">
            <h2 class="mb-3">Statistics</h2>
        </div>

        <!-- Trends Insights -->
        <div class="row g-3 mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">Monthly Trend</h6>
                        <div class="d-flex align-items-center justify-content-center">
                            {% if trends.monthly_change > 0 %}
                                <div>
                                    <h4 class="text-danger mb-0"><i class="bi bi-arrow-up-circle-fill text-danger fs-3 me-2"></i>+{{ trends.monthly_change }}%</h4>
                                    <small class="text-muted">Spending increased vs last month</small>
                                </div>
                            {% elif trends.monthly_change < 0 %}
                                <div>
                                    <h4 class="text-success mb-0"><i class="bi bi-arrow-down-circle-fill text-success fs-3 me-2"></i>{{ trends.monthly_change }}%</h4>
                                    <small class="text-muted">Spending decreased vs last month</small>
                                </div>
                            {% else %}
                                <div>
                                    <h4 class="text-muted mb-0"><i class="bi bi-dash-circle-fill text-muted fs-3 me-2"></i>0%</h4>
                                    <small class="text-muted">No change vs last month</small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">Top Spending Category</h6>
                        {% if trends.top_category %}
                            <div class="d-flex align-items-center justify-content-center">
                                <i class="bi bi-trophy-fill text-warning fs-3 me-2"></i>
                                <div>
                                    <h4 class="mb-0">{{ trends.top_category.category }}</h4>
                                    <small class="text-muted">${{ "%.2f"|format(trends.top_category.total) }} this month</small>
                                </div>
                            </div>
                        {% else %}
                            <p class="text-muted mb-0">No expenses this month</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Chart: Income vs Expenses -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                    <h5 class="card-title mb-0">Income vs Expenses</h5>
                    <div class="d-flex gap-2 flex-wrap">
                        <select id="timeView" class="form-select form-select-sm" style="width: auto;">
                            <option value="daily" {% if current_view == 'daily' %}selected{% endif %}>Daily</option>
                            <option value="weekly" {% if current_view == 'weekly' %}selected{% endif %}>Weekly</option>
                            <option value="monthly" {% if current_view == 'monthly' %}selected{% endif %}>Monthly</option>
                            <option value="annual" {% if current_view == 'annual' %}selected{% endif %}>Annual</option>
                        </select>
                        <select id="timePeriod" class="form-select form-select-sm" style="width: auto;">
                            <!-- Populated by JavaScript -->
                        </select>
                    </div>
                </div>
                <canvas id="histogramChart" style="max-height: 400px;"></canvas>
            </div>
        </div>

        <!-- Category Breakdown -->
        <div class="row g-4 mb-4">
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">Income by Category</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="incomePieChart"></canvas>
                        <div id="incomeEmpty" class="text-center py-5" style="display: none;">
                            <i class="bi bi-inbox display-4 text-muted"></i>
                            <p class="text-muted mt-3">No income data yet</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">Expenses by Category</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="expensesPieChart"></canvas>
                        <div id="expenseEmpty" class="text-center py-5" style="display: none;">
                            <i class="bi bi-inbox display-4 text-muted"></i>
                            <p class="text-muted mt-3">No expense data yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
{% endblock %}

{% block scripts %}
<script>
    const histogramData = {{ histogram_data|safe }};
    const incomeChartData = {{ income_chart|safe }};
    const expenseChartData = {{ expense_chart|safe }};
    const currentView = "{{ current_view }}";
    const currentPeriod = "{{ current_period }}";
    
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts(histogramData, incomeChartData, expenseChartData);
        initializeFilters(currentView, currentPeriod);
    });
</script>
{% endblock %}